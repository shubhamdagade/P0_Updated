<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>One Lodha Place | Air Quality Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="refresh" content="420">
    <link href="https://fonts.googleapis.com/css2?family=Jost:wght@200;300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --gold: #9e801b;
            --text-greyish: #777777; 
            --glass-bg: rgba(255, 255, 255, 0.35);
            --glass-border: rgba(255, 255, 255, 0.4);
            --faint-labelcard: rgba(68, 68, 68, 0.7);
            --faint-label: rgba(68, 68, 68, 0.8);
            --visible-grey: rgba(180, 180, 180, 0.5);
        }

        body, html { 
            margin: 0; padding: 0;
            height: 100vh; width: 100vw;
            font-family: 'Jost', sans-serif;
            background: url('background.jpg') no-repeat center center fixed; 
            background-size: cover;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-greyish);
            overflow: hidden;
        }

        /* Video Overlay */
        #video-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: black;
            z-index: 1000;
        }

        #video-overlay video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .dashboard-wrapper {
            width: 100vw; height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            padding: 6vh 0;
            box-sizing: border-box;
        }

        .header-section {
            display: flex;
            flex-direction: column;
            gap: 4vh;
            align-items: center;
        }

        .header-top, .footer-text {
            font-size: 2.5vh;
            font-weight: 500;
            text-transform: uppercase;
        }

        .main-headline {
            font-size: 4vh;
            font-weight: 400;
            text-transform: uppercase;
            letter-spacing: 0.2vw;
        }

        #status-text { font-weight: 600; }

        .card-container {
            display: flex;
            gap: 5vw;
            width: 100%;
            justify-content: center;
            align-items: center;
            flex-grow: 1;
        }

        .glass-card {
            background: var(--glass-bg);
            backdrop-filter: blur(25px);
            border-radius: 2.5vh;
            width: 50vh;
            height: 50vh;
            display: flex;
            flex-direction: column;
            justify-content: space-around;
            align-items: center;
            padding: 3vh 2vw;
            border: 0.2vh solid var(--glass-border);
            box-shadow: 0 4vh 8vh rgba(0,0,0,0.1);
        }

        #external-card { display: none; }

        .card-label {
            font-size: 3vh;
            text-transform: uppercase;
        }

        .card-label b { color: var(--faint-labelcard); }

        .aqi-value {
            font-size: 15vh;
            font-weight: 200;
            color: var(--gold);
            line-height: 0.7;
        }

        .metrics-box {
            display: flex;
            width: 100%;
            border: 0.25vh solid var(--visible-grey);
            border-radius: 2vh;
            padding: 2.5vh 0;
        }

        .metric-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .metric-label {
            font-size: 2.5vh;
            text-transform: uppercase;
            color: var(--faint-label);
        }

        .metric-val {
            font-size: 3vh;
            font-weight: 500;
            color: var(--gold);
        }

        .footer-container {
            display: flex;
            justify-content: center;
            align-items: center;
        }
    </style>
</head>

<body>

<!-- VIDEO OVERLAY -->
<div id="video-overlay">
    <video id="warning-video" loop muted autoplay playsinline>
        <source src="https://drive.google.com/uc?export=download&id=1viFP58rFoptqE2oalfbE64E7jgSMATeF" type="video/mp4">
        Your browser does not support the video tag.
    </video>
</div>

<!-- MAIN UI -->
<div class="dashboard-wrapper" id="main-ui">
    <div class="header-section">
        <div class="header-top">Live AQI</div>
        <div class="main-headline">
            Indoor Air Quality is <b id="status-text">Detecting...</b>
        </div>
    </div>

    <div class="card-container">
        <div class="glass-card">
            <div class="card-label"><b>Internal</b> AQI</div>
            <div class="aqi-value" id="in-aqi">--</div>
            <div class="metrics-box">
                <div class="metric-item">
                    <span class="metric-label">PM2.5</span>
                    <span class="metric-val" id="in-pm25">--</span>
                </div>
                <div class="metric-item" style="border-left: 0.25vh solid var(--visible-grey);">
                    <span class="metric-label">PM10</span>
                    <span class="metric-val" id="in-pm10">--</span>
                </div>
            </div>
        </div>

        <div class="glass-card" id="external-card">
            <div class="card-label"><b>External</b> AQI</div>
            <div class="aqi-value" id="out-aqi">--</div>
            <div class="metrics-box">
                <div class="metric-item">
                    <span class="metric-label">PM2.5</span>
                    <span class="metric-val" id="out-pm25">--</span>
                </div>
                <div class="metric-item" style="border-left: 0.25vh solid var(--visible-grey);">
                    <span class="metric-label">PM10</span>
                    <span class="metric-val" id="out-pm10">--</span>
                </div>
            </div>
        </div>
    </div>

    <div class="footer-container">
        <div class="footer-text">One Lodha Place, Mumbai</div>
    </div>
</div>

<script>
    const K_KEY = 'nomjPNZHYkGzzP5YIJePqI2cUON67v1pj9JPXb8BpcgnC5VX';
    const GOOGLE_KEY = 'AIzaSyD-sKAUFhaCGFENHqjlyrQfhbgOplhxy-Q';
    const LAT = 19.0000, LON = 72.8200;
    const DEVICE_IDS = ['f8d67086-a38d-4d2e-ac64-3b2cdbfd9964'];

    function calcAQI(pm) {
        if (pm <= 30) return Math.round(pm * 50 / 30);
        if (pm <= 60) return Math.round(50 + (pm - 30) * (50 / 30));
        if (pm <= 90) return Math.round(100 + (pm - 60) * (100 / 30));
        if (pm <= 120) return Math.round(200 + (pm - 90) * (100 / 30));
        if (pm <= 250) return Math.round(300 + (pm - 120) * (100 / 130));
        return 500;
    }

    async function updateData() {
        try {
            let indoorAQI = 0, outdoorAQI = 0;

            const fetches = DEVICE_IDS.map(id =>
                fetch(`https://api.kaiterra.com/v1/devices/${id}/top?key=${K_KEY}`).then(r => r.json())
            );

            const results = await Promise.allSettled(fetches);
            let pm25 = [];

            results.forEach(res => {
                if (res.status === 'fulfilled' && res.value.data) {
                    pm25.push(res.value.data.find(x => x.param === 'rpm25c').points[0].value);
                }
            });

            if (pm25.length) {
                const min25 = Math.min(...pm25);
                indoorAQI = calcAQI(min25);
                document.getElementById('in-aqi').innerText = indoorAQI;
                document.getElementById('status-text').innerText =
                    indoorAQI <= 15 ? "PRISTINE" :
                    indoorAQI <= 30 ? "EXCEPTIONAL" :
                    indoorAQI <= 45 ? "EXCELLENT" :
                    indoorAQI <= 60 ? "VERY GOOD" : "GOOD";
            }

            const gRes = await fetch(
                `https://airquality.googleapis.com/v1/currentConditions:lookup?key=${GOOGLE_KEY}`,
                {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        location: { latitude: LAT, longitude: LON },
                        extraComputations: ["LOCAL_AQI"]
                    })
                }
            );

            const gData = await gRes.json();
            if (gData.indexes) {
                outdoorAQI = (gData.indexes.find(i => i.code === 'ind_cpcb') || gData.indexes[0]).aqi;
                document.getElementById('out-aqi').innerText = outdoorAQI;
            }

            const video = document.getElementById('warning-video');
            const overlay = document.getElementById('video-overlay');
            const ui = document.getElementById('main-ui');

            if (indoorAQI > 50) {
                overlay.style.display = 'block';
                ui.style.display = 'none';
                video.play();
            } else {
                overlay.style.display = 'none';
                ui.style.display = 'flex';
                video.pause();
                document.getElementById('external-card').style.display =
                    Math.abs(outdoorAQI - indoorAQI) > 50 ? 'flex' : 'none';
            }

        } catch (e) {
            console.error(e);
        }
    }

    updateData();
    setInterval(updateData, 300000);
</script>

</body>
</html>
